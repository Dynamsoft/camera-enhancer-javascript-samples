<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/cube-dynamsoft-camera-enhancer@0.20220104111256.0/dist/dce.js"></script>
    <title>DCE_2.1_sample</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        button {
            border: 0;
        }

        #recognizerUI {
            position: absolute;
            top: 0;
            bottom: 30%;
            left: 0;
            right: 0;
        }

        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 30%;
            display: flex;
            border-top: 1px solid black;
            text-align: center;
        }

        footer .btn-group {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            border-right: 1px solid black;
            padding: 0 5px;
            width: 30%;
        }

        footer .btn-group button {
            height: 15%;
            border-radius: 5px;
            background-color: rgb(211,211,211);
        }

        footer .frame {
            width: 70%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        footer .frame .set-frame {
            height: 25%;
            border-bottom: 1px solid black;
            display: flex;
            flex-wrap: wrap;
        }

        footer .frame .set-frame input {
            width: 40%;
        }

        footer .frame .set-frame .set-scan-region {
            width: 20%;
            border: 1px solid black;
        }

        footer .frame .set-frame select {
            width: 20%;
        }

        footer .frame .show-frame {
            height: 75%;
        }

        footer .frame .show-frame canvas {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="recognizerUI"></div>
    <footer>
        <div class="btn-group">
            <button class="open-camera">open camera</button>
            <button class="get-frame">get frame</button>
            <select name="decorator" id="decorator">
                <option value="decorator">setViewDecorator</option>
                <option value="rectangle">rectangle</option>
                <option value="focus">focus</option>
                <option value="crossline">crossline</option>
                <option value="crosshair">crosshair</option>
            </select>
            <select name="LineWidth" id="LineWidth">
                <option value="">setViewDecoratorLineWidth</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
            </select>
            <select name="StrokeStyle" id="StrokeStyle">
                <option value="">setViewDecoratorStrokeStyle</option>
                <option value="skyblue">skyblue</option>
                <option value="red">red</option>
                <option value="purple">purple</option>
            </select>
            <select name="FillStyle" id="FillStyle">
                <option value="transparent">setViewDecoratorFillStyle</option>
                <option value="rgba(135, 206, 235, 0.3)">skyblue</option>
                <option value="rgba(255, 0, 0, 0.3)">red</option>
                <option value="rgba(128, 0, 128, 0.3)">purple</option>
            </select>
            <select name="MaskFillStyle" id="MaskFillStyle">
                <option value="transparent">setViewDecoratorMaskFillStyle</option>
                <option value="rgba(135, 206, 235, 0.3)">skyblue</option>
                <option value="rgba(255, 0, 0, 0.3)">red</option>
                <option value="rgba(128, 0, 128, 0.3)">purple</option>
            </select>
        </div>
        <div class="frame">
            <div class="set-frame">
                <input type="number" placeholder="scan region left">
                <input type="number" placeholder="scan region right">
                <select id="unit-selection">
                    <option value="%">%</option>
                    <option value="px">px</option>
                </select>
                <input type="number" placeholder="scan region top">
                <input type="number" placeholder="scan region bottom">
                <button class="set-scan-region">set</button>
            </div>
            <div class="show-frame"></div>
        </div>
    </footer>
    <script>
        let oc = document.querySelector('.open-camera');
        let gf = document.querySelector('.get-frame');
        let frame = document.querySelector('.show-frame');
        let decorator = document.querySelector('#decorator');
        let setLineWidth = document.querySelector('#LineWidth');
        let setStrokeStyle = document.querySelector('#StrokeStyle');
        let setFillStyle = document.querySelector('#FillStyle');
        let setMaskFillStyle = document.querySelector('#MaskFillStyle');
        let setDecorator = document.querySelector('#decorator');
        let inps = document.querySelectorAll('input')
        let unitSelection = document.querySelector('#unit-selection')
        let setScanRegion = document.querySelector('.set-scan-region')
        let enhancer;
        let area;
        
        // create a DCE instance and bind the callback
        let pReady = (async()=>{
            // Dynamsoft.DCE.CameraEnhancer.engineResourcePath = "https://unpkg.com/cube-dynamsoft-camera-enhancer@0.20220104111256.0/dist/"
            enhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance();
            const callbackCameraOpen = () => {
                console.log("camera opened");
            };
            // if close camera, should set the selection box to not selectable
            const callbackCameraClose = () => {
                console.log("camera closeed");
                setLineWidth.disabled = "disabled";
                setStrokeStyle.disabled = "disabled";
                setFillStyle.disabled = "disabled";
                setMaskFillStyle.disabled = "disabled";
                setDecorator.disabled = 'disabled';
            };
            const callbackCameraChange = () => {
                console.log("camera changed");
            };
            const callbackResolutionChange = () => {
                console.log("camera resolution changed");
            };
            enhancer.on("cameraOpen", callbackCameraOpen);
            enhancer.on("cameraClose", callbackCameraClose);
            enhancer.on("cameraChange", callbackCameraChange);
            enhancer.on("resolutionChange", callbackResolutionChange);
            if(!enhancer.isOpen()) {
                setLineWidth.disabled = "disabled";
                setStrokeStyle.disabled = "disabled";
                setFillStyle.disabled = "disabled";
                setMaskFillStyle.disabled = "disabled";
                setDecorator.disabled = 'disabled';
            }
        })()
        // set LineWidth
        setLineWidth.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            if(setLineWidth.value === '') {
                enhancer.setViewDecoratorLineWidth(DecoratorInfo.type[0],5);
            } else {
                enhancer.setViewDecoratorLineWidth(DecoratorInfo.type[0],parseInt(setLineWidth.value));
            }
        })

        // set StrokeStyle
        setStrokeStyle.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            if(setStrokeStyle.value === '') {
                enhancer.setViewDecoratorStrokeStyle(DecoratorInfo.type[0],'rgb(254,142,20)');
            } else {
                enhancer.setViewDecoratorStrokeStyle(DecoratorInfo.type[0],setStrokeStyle.value);
            }
        })
        
        // set FillStyle
        setFillStyle.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            enhancer.setViewDecoratorFillStyle(DecoratorInfo.type[0],setFillStyle.value);
        })

        // set MaskFillStyle
        setMaskFillStyle.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            enhancer.setViewDecoratorMaskFillStyle(DecoratorInfo.type[0],setMaskFillStyle.value);
        })

        // set Decorator
        setDecorator.addEventListener('change', ()=>{
            // if decorator is crossline or crosshair, can not set FillStyle and MaskFillStyle
            if(setDecorator.value === 'crossline' || setDecorator.value === 'crosshair') {
                setFillStyle.disabled = "disabled";
                setMaskFillStyle.disabled = "disabled";
            } else if(setDecorator.value === 'rectangle' || setDecorator.value === 'focus') {
                setFillStyle.disabled = "";
                setMaskFillStyle.disabled = "";
                setLineWidth.disabled = "";
                setStrokeStyle.disabled = "";
            }
            enhancer.setViewDecorator(setDecorator.value, area);
        })

        // open camera
        oc.addEventListener('click', async ()=>{
            await pReady;
            if(enhancer.isOpen()) { 
                return;
            } else {
                area = {x: 10, y:10, width:80, height:80};
                document.querySelector('#recognizerUI').appendChild(enhancer.getUIElement());
                await enhancer.open(true);
                // A decorator must be set to select a style
                if(enhancer.getViewDecorator().type.length !== 0) {
                    setLineWidth.disabled = "";
                    setStrokeStyle.disabled = "";
                    setFillStyle.disabled = "";
                    setMaskFillStyle.disabled = "";
                }
                setDecorator.disabled = '';
            }
            
        })

        setScanRegion.addEventListener('click', ()=>{
            // set scan region
            enhancer.setScanRegion({
                regionLeft: parseInt(inps[0].value) || 0,
                regionTop: parseInt(inps[2].value) || 0, 
                regionRight: parseInt(inps[1].value) || 100, 
                regionBottom: parseInt(inps[3].value) || 100, 
                // if true use %, if false use px
                regionMeasuredByPercentage: unitSelection.value === '%' ? true : false
            });
        })

        // get frame
        gf.addEventListener('click', async ()=>{
            await pReady;
            if(!enhancer.isOpen()) {
                return;
            } else {
                let frameData = enhancer.getFrame();
                frame.innerHTML = '';
                frame.appendChild(frameData.canvas);
            }
        })
    </script>
</body>
</html>
