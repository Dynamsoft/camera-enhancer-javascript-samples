<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/cube-dynamsoft-camera-enhancer@0.20220104111256.0/dist/dce.js"></script>
    <title>DCE_2.1_sample</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        button {
            border: 0;
        }

        .dce-sel-camera, .dce-sel-resolution {
            width: 50% !important;
            height: 30px;
            top: -30px !important;
            border: 0;
            background-color: lightgray;
        }

        .dce-sel-camera {
            border-right: 1px solid black;
        }

        .dce-sel-resolution {
            left: 50% !important;
        }

        #recognizerUI {
            position: absolute;
            top: 30px;
            bottom: 30%;
            left: 0;
            right: 0;
            display: none;
        }

        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 30%;
            display: flex;
            border-top: 1px solid black;
            text-align: center;
        }

        footer .btn-group {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            border-right: 1px solid black;
            padding: 0 5px;
            width: 30%;
        }

        footer .btn-group button {
            height: 15%;
            border-radius: 5px;
            background-color: rgb(211,211,211);
        }

        footer .frame {
            width: 70%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        footer .frame .set-frame {
            height: 25%;
            border-bottom: 1px solid black;
            display: flex;
            flex-wrap: wrap;
        }

        footer .frame .set-frame input {
            width: 40%;
        }

        footer .frame .set-frame select {
            width: 20%;
        }

        footer .frame .show-frame {
            height: 75%;
        }

        footer .frame .show-frame canvas {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="recognizerUI"></div>
    <footer>
        <div class="btn-group">
            <button class="open-camera">open camera</button>
            <button class="get-frame">get frame</button>
            <select name="LineWidth" id="LineWidth">
                <option value="">LineWidth</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
            </select>
            <select name="StrokeStyle" id="StrokeStyle">
                <option value="">StrokeStyle</option>
                <option value="skyblue">skyblue</option>
                <option value="red">red</option>
                <option value="purple">purple</option>
            </select>
            <select name="FillStyle" id="FillStyle">
                <option value="">FillStyle</option>
                <option value="rgba(135, 206, 235, 0.3)">skyblue</option>
                <option value="rgba(255, 0, 0, 0.3)">red</option>
                <option value="rgba(128, 0, 128, 0.3)">purple</option>
            </select>
            <select name="MaskFillStyle" id="MaskFillStyle">
                <option value="">MaskFillStyle</option>
                <option value="rgba(135, 206, 235, 0.3)">skyblue</option>
                <option value="rgba(255, 0, 0, 0.3)">red</option>
                <option value="rgba(128, 0, 128, 0.3)">purple</option>
            </select>
            <select name="decorator" id="decorator">
                <option value="rectangle">rectangle</option>
                <option value="focus">focus</option>
                <option value="crossline">crossline</option>
                <option value="crosshair">crosshair</option>
            </select>
        </div>
        <div class="frame">
            <div class="set-frame">
                <input type="number" placeholder="left(0)">
                <input type="number" placeholder="right(100)">
                <select id="unit-selection">
                    <option value="%">%</option>
                    <option value="px">px</option>
                </select>
                <input type="number" placeholder="top(0)">
                <input type="number" placeholder="bottom(100)">
            </div>
            <div class="show-frame"></div>
        </div>
    </footer>
    <script>
        let ui = document.querySelector('#recognizerUI');
        let oc = document.querySelector('.open-camera');
        let gf = document.querySelector('.get-frame');
        let frame = document.querySelector('.show-frame');
        let decorator = document.querySelector('#decorator');
        let setLineWidth = document.querySelector('#LineWidth');
        let setStrokeStyle = document.querySelector('#StrokeStyle');
        let setFillStyle = document.querySelector('#FillStyle');
        let setMaskFillStyle = document.querySelector('#MaskFillStyle');
        let setDecorator = document.querySelector('#decorator');
        let inps = document.querySelectorAll('input')
        let unitSelection = document.querySelector('#unit-selection')
        let enhancer;
        let area;
        
        // create a DCE instance and bind the callback
        let pReady = (async()=>{
            // Dynamsoft.DCE.CameraEnhancer.engineResourcePath = "https://unpkg.com/cube-dynamsoft-camera-enhancer@0.20220104111256.0/dist/"
            enhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance();
            document.querySelector('#recognizerUI').appendChild(enhancer.getUIElement());
            const callbackCameraOpen = () => {
                console.log("camera opened");
            };
            const callbackCameraClose = () => {
                console.log("camera closeed");
                setLineWidth.disabled = "disabled";
                setStrokeStyle.disabled = "disabled";
                setFillStyle.disabled = "disabled";
                setMaskFillStyle.disabled = "disabled";
                setDecorator.disabled = 'disabled';
            };
            const callbackCameraChange = () => {
                console.log("camera changed");
            };
            const callbackResolutionChange = () => {
                console.log("camera resolution changed");
            };
            enhancer.on("cameraOpen", callbackCameraOpen);
            enhancer.on("cameraClose", callbackCameraClose);
            enhancer.on("cameraChange", callbackCameraChange);
            enhancer.on("resolutionChange", callbackResolutionChange);
            if(!enhancer.isOpen()) {
                setLineWidth.disabled = "disabled";
                setStrokeStyle.disabled = "disabled";
                setFillStyle.disabled = "disabled";
                setMaskFillStyle.disabled = "disabled";
                setDecorator.disabled = 'disabled';
            }
        })()
        // set LineWidth
        setLineWidth.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            enhancer.setViewDecoratorLineWidth(DecoratorInfo.type[0],setLineWidth.value*1);
        })

        // set StrokeStyle
        setStrokeStyle.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            enhancer.setViewDecoratorStrokeStyle(DecoratorInfo.type[0],setStrokeStyle.value);
        })
        
        // set FillStyle
        setFillStyle.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            enhancer.setViewDecoratorFillStyle(DecoratorInfo.type[0],setFillStyle.value);
        })

        // set MaskFillStyle
        setMaskFillStyle.addEventListener('change', ()=>{
            let DecoratorInfo = enhancer.getViewDecorator();
            enhancer.setViewDecoratorMaskFillStyle(DecoratorInfo.type[0],setMaskFillStyle.value);
        })

        // set Decorator
        setDecorator.addEventListener('change', ()=>{
            if(setDecorator.value === 'crossline' || setDecorator.value === 'crosshair') {
                setFillStyle.disabled = "disabled";
                setMaskFillStyle.disabled = "disabled";
            } else if(setDecorator.value === 'rectangle' || setDecorator.value === 'focus') {
                setFillStyle.disabled = "";
                setMaskFillStyle.disabled = "";
            }
            enhancer.setViewDecorator(setDecorator.value, area);
        })

        // open camera
        oc.addEventListener('click', async ()=>{
            await pReady;
            if(enhancer.isOpen()) { 
                return;
            } else {
                area = {x: 10, y:10, width:80, height:80};
                await enhancer.open(true);
                setLineWidth.disabled = "";
                setStrokeStyle.disabled = "";
                setFillStyle.disabled = "";
                setMaskFillStyle.disabled = "";
                setDecorator.disabled = '';
                enhancer.setViewDecorator(setDecorator.value, area);
                ui.style.display = 'block';
            }
            
        })

        // get frame
        gf.addEventListener('click', async ()=>{
            await pReady;
            if(!enhancer.isOpen()) {
                return;
            } else {
                let canvas = document.querySelectorAll('canvas')
                if(canvas.length > 1) {
                    frame.innerHTML = '';
                }
                enhancer.setScanRegion({
                    regionLeft: inps[0].value*1 || 0,
                    regionTop: inps[2].value*1 || 0, 
                    regionRight: inps[1].value*1 || 100, 
                    regionBottom: inps[3].value*1 || 100, 
                    regionMeasuredByPercentage: unitSelection.value === '%' ? true : false
                });
                let frameData = enhancer.getFrame();
                frame.appendChild(frameData.canvas);
            }
        })
    </script>
</body>
</html>
